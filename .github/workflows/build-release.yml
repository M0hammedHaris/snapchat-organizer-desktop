name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0-alpha
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-macos:
    name: Build macOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build with PyInstaller
      run: |
        pyinstaller snapchat-organizer.spec --clean --noconfirm
        
    - name: Create DMG
      run: |
        # Create temporary directory for DMG contents
        mkdir -p dist/dmg
        cp -R "dist/Snapchat Organizer.app" dist/dmg/
        
        # Create symbolic link to Applications folder
        ln -s /Applications dist/dmg/Applications
        
        # Create DMG
        hdiutil create -volname "Snapchat Organizer" \
                       -srcfolder dist/dmg \
                       -ov -format UDZO \
                       "dist/Snapchat-Organizer-macOS.dmg"
        
        rm -rf dist/dmg
        
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: |
          dist/Snapchat Organizer.app
          dist/Snapchat-Organizer-macOS.dmg
        retention-days: 90
        
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build with PyInstaller
      run: |
        pyinstaller snapchat-organizer.spec --clean --noconfirm
        
    - name: Create ZIP
      run: |
        Compress-Archive -Path "dist\Snapchat Organizer\*" -DestinationPath "dist\Snapchat-Organizer-Windows.zip"
        
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/Snapchat-Organizer-Windows.zip
        retention-days: 90
        
  build-linux:
    name: Build Linux App
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build with PyInstaller
      run: |
        pyinstaller snapchat-organizer.spec --clean --noconfirm
        
    - name: Create tarball
      run: |
        cd dist
        tar -czf Snapchat-Organizer-Linux.tar.gz "Snapchat Organizer"
        
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: dist/Snapchat-Organizer-Linux.tar.gz
        retention-days: 90
        
  create-release:
    name: Create GitHub Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        
        # macOS DMG
        cp artifacts/macos-build/*.dmg release-assets/ || true
        
        # Windows ZIP
        cp artifacts/windows-build/*.zip release-assets/ || true
        
        # Linux tarball
        cp artifacts/linux-build/*.tar.gz release-assets/ || true
        
        ls -lh release-assets/
        
    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Create Release Notes
      id: release_notes
      run: |
        cat > release-notes.md << 'EOF'
        # Snapchat Organizer Desktop ${{ steps.get_version.outputs.VERSION }}
        
        ## ðŸŽ‰ Alpha Release - Testing Phase
        
        Thank you for helping test Snapchat Organizer Desktop!
        
        ### âœ¨ Features
        
        - **Download Tab**: Download Snapchat memories from HTML exports
        - **Organize Tab**: Organize chat media by person with intelligent 3-tier matching
        - **Tools Tab**: 6 utility tools for media management
          - Verify file integrity
          - Remove duplicates
          - Organize by year
          - Fix timestamps
          - Convert timezones (coming soon)
          - Apply overlays (coming soon)
        - **Settings**: Customize paths, behavior, and processing options
        - **Help System**: Step-by-step Snapchat data download guide
        
        ### ðŸ“¦ Downloads
        
        - **macOS**: `Snapchat-Organizer-macOS.dmg` (macOS 10.13+)
          - **First run**: Right-click â†’ Open (security warning is normal)
          - See [macOS Installation Guide](docs/releases/alpha/MACOS_INSTALLATION.md)
        - **Windows**: `Snapchat-Organizer-Windows.zip` (Windows 10/11)
          - **First run**: Click "More info" â†’ "Run anyway" when SmartScreen appears
          - See [Windows Installation Guide](docs/releases/alpha/WINDOWS_INSTALLATION.md) for detailed steps
        - **Linux**: `Snapchat-Organizer-Linux.tar.gz` (Ubuntu 20.04+)
        
        ### ðŸ“‹ Requirements
        
        - No Python installation required (standalone builds)
        - Snapchat data export (see Help menu in app)
        
        ### ðŸ›¡ï¸ Security Warnings (Expected & Safe!)
        
        **macOS Users:** You may see "unidentified developer" warning
        - **Why:** App is not notarized (costs money, planned for Phase 3)
        - **Safe to bypass:** Right-click app â†’ Open â†’ Click "Open" again
        - **One-time only:** After first launch, opens normally
        
        **Windows Users:** You may see SmartScreen "Windows protected your PC" warning
        - **Why:** App is not code-signed (certificates cost $300-500/year, planned for Phase 3)
        - **Safe to bypass:** Click "More info" â†’ Click "Run anyway"
        - **One-time only:** After first launch, opens normally
        - **ðŸ“– Detailed guide:** See [WINDOWS_INSTALLATION.md](docs/releases/alpha/WINDOWS_INSTALLATION.md)
        
        **Why these warnings appear:**
        - This is normal for all new indie apps not distributed through app stores
        - Code signing certificates cost $300-500/year (not feasible for alpha testing)
        - The app is completely safe - all code is open source and reviewable
        - No network activity except downloading from Snapchat URLs (optional)
        - All processing happens locally on your device
        
        ### ðŸ› Known Issues
        
        - First launch may be slow (normal for PyInstaller apps)
        - macOS may show "unidentified developer" warning (see above - safe to bypass)
        - Windows may show SmartScreen warning (see above - safe to bypass)
        - Timezone conversion and overlay compositing coming in next release
        
        ### ðŸ“ Testing Instructions
        
        1. Download the appropriate file for your OS
        2. Extract/mount and run the application
        3. **Bypass security warning if prompted** (one-time only, completely safe)
        4. Press F1 for help or see the Help menu
        5. Follow the testing guide in `docs/releases/alpha/ALPHA_TESTING_GUIDE.md`
        
        ### ðŸ™ Feedback
        
        Please report bugs and suggestions:
        - GitHub Issues: [Create Issue](https://github.com/M0hammedHaris/snapchat-organizer-desktop/issues/new)
        - Email: [Your Email]
        
        ---
        
        **Full Changelog**: https://github.com/M0hammedHaris/snapchat-organizer-desktop/compare/v${{ steps.get_version.outputs.VERSION }}
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Alpha ${{ steps.get_version.outputs.VERSION }}
        body_path: release-notes.md
        draft: false
        prerelease: true
        files: release-assets/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
